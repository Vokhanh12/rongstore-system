version: 1
service: iam
updated_at: "2025-08-17"
owner: platform-auth

conventions:
  code_format: "<DOMAIN>-<AREA>-<NNN>"
  domain: "AUTH"
  areas:
    HAND: "Handshake"
    LOGIN: "Login"
    TOKEN: "Access/Refresh token"
    RL: "Rate limit"
    VAL: "Validation"
    INFRA: "Infrastructure"
  severity_scale:
    S1: "Critical outage/security risk"
    S2: "Degraded experience or important failure"
    S3: "Minor / client input issue"
  retry_policy:
    retryable_statuses_http: [408, 429, 500, 502, 503, 504]
    grpc_retryable: ["Unavailable", "DeadlineExceeded"]

errors:
  # ---------- Handshake ----------
  - code: AUTH-HAND-001
    key: HANDSHAKE_INVALID_CLIENT_KEY
    http_status: 400
    grpc_code: InvalidArgument
    message: "Invalid client public key"
    severity: S3
    retryable: false
    cause: "Client sent malformed/unsupported public key"
    client_action: "Validate/generate correct key and retry"
    server_action: "Log warn with trace_id; no alert"

  - code: AUTH-HAND-002
    key: HANDSHAKE_KEY_AGREEMENT_FAIL
    http_status: 422
    grpc_code: FailedPrecondition
    message: "Key agreement failed"
    severity: S3
    retryable: false
    cause: "ECDH derive failed due to incompatible/invalid key"
    client_action: "Regenerate keypair on supported curve"
    server_action: "Log warn; verify accepted curves list"

  - code: AUTH-HAND-003
    key: HANDSHAKE_RNG_FAIL
    http_status: 500
    grpc_code: Internal
    message: "Server crypto failure"
    severity: S1
    retryable: true
    cause: "CSPRNG or key generation failure"
    client_action: "Retry with backoff; if persists, contact support"
    server_action: "Alert; check entropy/OS crypto, hosts"

  - code: AUTH-HAND-004
    key: HANDSHAKE_ENCRYPT_FAIL
    http_status: 500
    grpc_code: Internal
    message: "Failed to encrypt session"
    severity: S2
    retryable: true
    cause: "AES session data encryption failed"
    client_action: "Retry with backoff"
    server_action: "Log error; investigate crypto lib/config"

  # ---------- Login ----------
  - code: AUTH-LOGIN-001
    key: INVALID_CREDENTIALS
    http_status: 401
    grpc_code: Unauthenticated
    message: "Invalid email or password"
    severity: S3
    retryable: false
    cause: "Wrong credentials"
    client_action: "Prompt user to re-enter credentials"
    server_action: "Log info; consider login attempt metrics"

  - code: AUTH-LOGIN-002
    key: USER_LOCKED
    http_status: 423
    grpc_code: PermissionDenied
    message: "User account locked"
    severity: S2
    retryable: false
    cause: "Too many failed attempts or admin lock"
    client_action: "Display lock reason; suggest recovery"
    server_action: "Log warn; surface unlock workflow"

  # ---------- Token ----------
  - code: AUTH-TOKEN-001
    key: TOKEN_EXPIRED
    http_status: 401
    grpc_code: Unauthenticated
    message: "Token expired"
    severity: S3
    retryable: false
    cause: "Access token beyond exp"
    client_action: "Use refresh token or re-login"
    server_action: "Log info; track token expiry patterns"

  - code: AUTH-TOKEN-002
    key: TOKEN_MALFORMED
    http_status: 400
    grpc_code: InvalidArgument
    message: "Malformed token"
    severity: S3
    retryable: false
    cause: "Invalid JWT format/signature header"
    client_action: "Send a valid token"
    server_action: "Log warn; do not expose details"

  # ---------- Validation ----------
  - code: AUTH-VAL-001
    key: VALIDATION_FAILED
    http_status: 400
    grpc_code: InvalidArgument
    message: "Validation failed"
    severity: S3
    retryable: false
    cause: "Missing/invalid input fields"
    client_action: "Fix fields as indicated"
    server_action: "Log debug; include field names (safe)"

  # ---------- Rate Limit ----------
  - code: AUTH-RL-001
    key: RATE_LIMITED
    http_status: 429
    grpc_code: ResourceExhausted
    message: "Too many requests"
    severity: S2
    retryable: true
    cause: "Rate limit exceeded"
    client_action: "Respect Retry-After and backoff"
    server_action: "Expose Retry-After; monitor abuse"

  # ---------- Infrastructure ----------
  - code: AUTH-INFRA-001
    key: DB_TIMEOUT
    http_status: 503
    grpc_code: Unavailable
    message: "Service temporarily unavailable"
    severity: S1
    retryable: true
    cause: "Database timeout or overload"
    client_action: "Retry with exponential backoff"
    server_action: "Alert; check DB health/capacity"

  - code: AUTH-INFRA-002
    key: DOWNSTREAM_UNAVAILABLE
    http_status: 503
    grpc_code: Unavailable
    message: "Dependency unavailable"
    severity: S1
    retryable: true
    cause: "External service down"
    client_action: "Retry with backoff"
    server_action: "Alert; circuit breaker; failover"

defaults:
  unknown_domain_key:
    code: AUTH-VAL-999
    http_status: 400
    grpc_code: InvalidArgument
    message: "Unknown domain error"
  internal_fallback:
    code: CORE-INF-000
    http_status: 500
    grpc_code: Internal
    message: "Internal server error"
