version: 1
updated_at: "2025-08-17"
owner: platform-auth

services:
  iam:
    conventions:
      code_format: "<DOMAIN>-<AREA>-<NNN>"
      domain: "AUTH"
      severity_scale:
        S1: "Critical outage/security risk"
        S2: "Degraded experience or important failure"
        S3: "Minor / client input issue"
      retry_policy:
        retryable_statuses_http: [408, 429, 500, 502, 503, 504]
        grpc_retryable: ["Unavailable", "DeadlineExceeded"]

    errors:
      VAL:
        - code: AUTH-VAL-001
          key: LOGIN_EMAIL_EMPTY
          http_status: 400
          grpc_code: InvalidArgument
          message: "Email is required"
          severity: S3
          retryable: false
          cause: "Missing email in login request"
          client_action: "Ask user to enter email"
          server_action: "Log debug; no alert"

        - code: AUTH-VAL-002
          key: LOGIN_EMAIL_INVALID
          http_status: 400
          grpc_code: InvalidArgument
          message: "Invalid email format"
          severity: S3
          retryable: false
          cause: "Email does not match RFC regex"
          client_action: "Validate email before submitting"
          server_action: "Log debug for malformed input"

        - code: AUTH-VAL-003
          key: LOGIN_PASSWORD_EMPTY
          http_status: 400
          grpc_code: InvalidArgument
          message: "Password is required"
          severity: S3
          retryable: false
          cause: "Missing password in login request"
          client_action: "Ask user to re-enter password"
          server_action: "Log debug"

        - code: AUTH-VAL-004
          key: LOGIN_PAYLOAD_INVALID
          http_status: 400
          grpc_code: InvalidArgument
          message: "Invalid request payload"
          severity: S3
          retryable: false
          cause: "Malformed JSON or missing fields"
          client_action: "Fix request body"
          server_action: "Log warn for debug purposes"

      HAND:
        - code: AUTH-HAND-001
          key: HANDSHAKE_INVALID_CLIENT_KEY
          http_status: 400
          grpc_code: InvalidArgument
          message: "Invalid client public key"
          severity: S3
          retryable: false
          cause: "Client sent malformed/unsupported public key"
          client_action: "Validate/generate correct key and retry"
          server_action: "Log warn with trace_id; no alert"

        - code: AUTH-HAND-002
          key: HANDSHAKE_KEY_AGREEMENT_FAIL
          http_status: 422
          grpc_code: FailedPrecondition
          message: "Key agreement failed"
          severity: S3
          retryable: false
          cause: "ECDH derive failed due to incompatible/invalid key"
          client_action: "Regenerate keypair on supported curve"
          server_action: "Log warn; verify accepted curves list"

        - code: AUTH-HAND-003
          key: HANDSHAKE_RNG_FAIL
          http_status: 500
          grpc_code: Internal
          message: "Random generation failed"
          severity: S1
          retryable: true
          cause: "System RNG failure"
          client_action: "Retry handshake"
          server_action: "Alert; investigate RNG availability"

        - code: AUTH-HAND-004
          key: HANDSHAKE_KEY_DERIVE_FAIL
          http_status: 500
          grpc_code: Internal
          message: "Key derivation failed"
          severity: S1
          retryable: true
          cause: "HKDF derivation failed"
          client_action: "Retry handshake"
          server_action: "Alert; investigate HKDF process"

        - code: AUTH-HAND-005
          key: HANDSHAKE_STORAGE_FAIL
          http_status: 500
          grpc_code: Internal
          message: "Failed to store session"
          severity: S1
          retryable: true
          cause: "Redis/DB failure during session storage"
          client_action: "Retry handshake"
          server_action: "Alert; check session store health"

      LOGIN:
        - code: AUTH-LOGIN-001
          key: INVALID_CREDENTIALS
          http_status: 401
          grpc_code: Unauthenticated
          message: "Invalid email or password"
          severity: S3
          retryable: false
          cause: "Wrong credentials"
          client_action: "Prompt user to re-enter credentials"
          server_action: "Log info; consider login attempt metrics"

      TOKEN:
        - code: AUTH-TOKEN-001
          key: TOKEN_EXPIRED
          http_status: 401
          grpc_code: Unauthenticated
          message: "Token expired"
          severity: S3
          retryable: false
          cause: "Access token beyond exp"
          client_action: "Use refresh token or re-login"
          server_action: "Log info; track token expiry patterns"

      INFRA:
      - code: AUTH-INFRA-001
        key: DB_TIMEOUT
        http_status: 503
        grpc_code: Unavailable
        message: "Database service temporarily unavailable"
        severity: S1
        retryable: true
        cause: "Database timeout or overload"
        client_action: "Retry with exponential backoff"
        server_action: "Alert; check DB health/capacity"

      - code: AUTH-INFRA-002
        key: REDIS_UNAVAILABLE
        http_status: 503
        grpc_code: Unavailable
        message: "Redis cache temporarily unavailable"
        severity: S1
        retryable: true
        cause: "Redis connection failed or timeout"
        client_action: "Retry operation after delay"
        server_action: "Alert; check Redis cluster health"

      - code: AUTH-INFRA-003
        key: KEYCLOAK_UNAVAILABLE
        http_status: 503
        grpc_code: Unavailable
        message: "Keycloak service temporarily unavailable"
        severity: S1
        retryable: true
        cause: "Keycloak server unreachable or timeout"
        client_action: "Retry authentication/authorization"
        server_action: "Alert; verify Keycloak server status"

      - code: AUTH-INFRA-004
        key: POSTGRES_UNAVAILABLE
        http_status: 503
        grpc_code: Unavailable
        message: "Postgres database service temporarily unavailable"
        severity: S1
        retryable: true
        cause: "Cannot connect to Postgres after multiple retries"
        client_action: "Retry operation after delay"
        server_action: "Alert; verify Postgres server health"

      - code: AUTH-INFRA-005
        key: KEYCLOAK_CONFIG_INVALID
        http_status: 500
        grpc_code: Internal
        message: "Invalid Keycloak configuration"
        severity: S1
        retryable: false
        cause: "Keycloak URL/credentials/realm invalid"
        client_action: "Contact support"
        server_action: "Alert; verify Keycloak configuration"

      - code: AUTH-INFRA-006
        key: KEYCLOAK_HEALTH_ENDPOINT_INVALID
        http_status: 502
        grpc_code: Unavailable
        message: "Invalid Keycloak health endpoint"
        severity: S1
        retryable: true
        cause: "Health check path incorrect or disabled"
        client_action: "Retry later"
        server_action: "Fix health endpoint configuration"

      - code: AUTH-INFRA-007
        key: KEYCLOAK_INTERNAL
        http_status: 500
        grpc_code: Internal
        message: "Keycloak internal error"
        severity: S1
        retryable: true
        cause: "Keycloak returned 500 during health check or API call"
        client_action: "Retry operation"
        server_action: "Investigate Keycloak logs for root cause"

      - code: AUTH-INFRA-008
        key: KEYCLOAK_TOKEN_REQUEST_FAIL
        http_status: 503
        grpc_code: Unavailable
        message: "Failed to request access token"
        severity: S1
        retryable: true
        cause: "Timeout or connection error when requesting token"
        client_action: "Retry with backoff"
        server_action: "Check Keycloak token endpoint"

      - code: AUTH-INFRA-009
        key: KEYCLOAK_TOKEN_INVALID
        http_status: 401
        grpc_code: Unauthenticated
        message: "Invalid or expired Keycloak token"
        severity: S2
        retryable: false
        cause: "Token expired or invalid signature"
        client_action: "Refresh token or re-login"
        server_action: "Log info; track invalid token usage"

      - code: AUTH-INFRA-010
        key: KEYCLOAK_REFRESH_TOKEN_FAIL
        http_status: 503
        grpc_code: Unavailable
        message: "Failed to refresh token"
        severity: S1
        retryable: true
        cause: "Timeout, 5xx error from Keycloak"
        client_action: "Retry"
        server_action: "Alert if occurs frequently"

      - code: AUTH-INFRA-011
        key: KEYCLOAK_USER_NOT_FOUND
        http_status: 404
        grpc_code: NotFound
        message: "Keycloak user not found"
        severity: S2
        retryable: false
        cause: "Requested user does not exist in Keycloak"
        client_action: "Check user ID"
        server_action: "Log info"

      - code: AUTH-INFRA-012
        key: KEYCLOAK_USER_CREATE_FAIL
        http_status: 503
        grpc_code: Unavailable
        message: "Failed to create Keycloak user"
        severity: S1
        retryable: true
        cause: "Keycloak returned 5xx during user creation"
        client_action: "Retry"
        server_action: "Alert; check Keycloak user endpoints"

      - code: AUTH-INFRA-013
        key: KEYCLOAK_USER_UPDATE_FAIL
        http_status: 503
        grpc_code: Unavailable
        message: "Failed to update Keycloak user"
        severity: S1
        retryable: true
        cause: "5xx or timeout during update"
        client_action: "Retry"
        server_action: "Investigate Keycloak uptime"

      - code: AUTH-INFRA-014
        key: KEYCLOAK_USER_DELETE_FAIL
        http_status: 503
        grpc_code: Unavailable
        message: "Failed to delete Keycloak user"
        severity: S1
        retryable: true
        cause: "5xx error during delete"
        client_action: "Retry"
        server_action: "Check Keycloak admin API availability"

      - code: AUTH-INFRA-015
        key: KEYCLOAK_CLIENT_INVALID
        http_status: 400
        grpc_code: InvalidArgument
        message: "Invalid Keycloak client configuration"
        severity: S2
        retryable: false
        cause: "Client ID/secret mismatched or missing"
        client_action: "Contact support"
        server_action: "Fix client config in Keycloak"

      - code: AUTH-INFRA-016
        key: KEYCLOAK_REALM_NOT_FOUND
        http_status: 404
        grpc_code: NotFound
        message: "Keycloak realm not found"
        severity: S2
        retryable: false
        cause: "Realm name incorrect"
        client_action: "Verify realm configuration"
        server_action: "Log warn; validate realm list"

      - code: AUTH-INFRA-017
        key: KEYCLOAK_ROLE_ASSIGN_FAIL
        http_status: 503
        grpc_code: Unavailable
        message: "Failed to assign Keycloak role"
        severity: S1
        retryable: true
        cause: "Keycloak role mapping API returned 5xx"
        client_action: "Retry"
        server_action: "Investigate Keycloak admin role API"

      - code: AUTH-INFRA-018
        key: KEYCLOAK_TIMEOUT
        http_status: 504
        grpc_code: DeadlineExceeded
        message: "Keycloak request timeout"
        severity: S1
        retryable: true
        cause: "Network congestion or slow Keycloak response"
        client_action: "Retry with backoff"
        server_action: "Monitor latency; check Keycloak CPU/memory"

      - code: AUTH-INFRA-019
        key: KEYCLOAK_BAD_GATEWAY
        http_status: 502
        grpc_code: Unavailable
        message: "Bad gateway from Keycloak"
        severity: S1
        retryable: true
        cause: "Reverse proxy or Keycloak pod down"
        client_action: "Retry"
        server_action: "Investigate load balancer / ingress"

      - code: AUTH-INFRA-020
        key: KEYCLOAK_GATEWAY_TIMEOUT
        http_status: 504
        grpc_code: DeadlineExceeded
        message: "Gateway timeout communicating with Keycloak"
        severity: S1
        retryable: true
        cause: "Request exceeded ingress/NGINX timeout"
        client_action: "Retry"
        server_action: "Increase gateway timeout or optimize endpoint"

  hr:
    conventions:
      code_format: "<DOMAIN>-<AREA>-<NNN>"
      domain: "HRM"
      areas:
        EMP: "Employee"
        PAY: "Payroll"
        LEAVE: "Leave Management"
        RL: "Rate limit"
        VAL: "Validation"
        INFRA: "Infrastructure"
      severity_scale:
        S1: "Critical outage/security risk"
        S2: "Degraded experience or important failure"
        S3: "Minor / client input issue"
      retry_policy:
        retryable_statuses_http: [408, 429, 500, 502, 503, 504]
        grpc_retryable: ["Unavailable", "DeadlineExceeded"]

    errors:
      EMP:
        - code: HR-EMP-001
          key: EMPLOYEE_NOT_FOUND
          http_status: 404
          grpc_code: NotFound
          message: "Employee not found"
          severity: S2
          retryable: false
          cause: "Invalid employee ID"
          client_action: "Check employee ID"
          server_action: "Log info; monitor invalid access attempts"

      PAY:
        - code: HR-PAY-001
          key: PAYROLL_PROCESS_FAIL
          http_status: 500
          grpc_code: Internal
          message: "Payroll processing failed"
          severity: S1
          retryable: true
          cause: "DB or external service failure"
          client_action: "Retry later"
          server_action: "Alert finance ops; investigate DB/services"

      LEAVE:
        - code: HR-LEAVE-001
          key: LEAVE_REQUEST_INVALID
          http_status: 400
          grpc_code: InvalidArgument
          message: "Invalid leave request"
          severity: S3
          retryable: false
          cause: "Invalid date or quota"
          client_action: "Correct leave request"
          server_action: "Log debug; track invalid requests"

defaults:
  UNKNOWN_DOMAIN_KEY:
    code: AUTH-VAL-999
    http_status: 400
    grpc_code: InvalidArgument
    message: "Unknown domain error"

  INTERNAL_FALLBACK:
    code: CORE-INF-000
    http_status: 500
    grpc_code: Internal
    message: "Internal server error"
